{% extends "varnishpurge/_layouts/cp" %}

{% set selectedSubnavItem = "" %}

{% import "_includes/forms" as forms %}

{% block pageHeader %}
	{{ parent() }}

	<form id="frm-banall">
		<input type="submit" class="btn submit" value="Clear entire cache" data-modal-trigger="varnish-confirm-purge">
	</form>
{% endblock %}

{% set content %}
	<div id="tab-purge">
		<form id="frm-purge" class="purgeban">
			<fieldset>
				<div class="heading">
					<label id="title-label" class="required" for="purge-uri">URI</label>
				</div>

				<div class="purgeban-query">
					{# <span class="prefix">{{ craft.config.get('varnishUrl', 'varnishpurge') }}</span> #}
					<div class="select">
						<select name="host">
							<option value="">{{ 'Send to all hosts'|t }}</option>
							{% for id, host in hosts %}
							<option value="{{ id }}">{{ id }} ({{ host.hostName }})</option>
							{% endfor %}
						</select>
					</div>
					<input class="text" type="text" id="purge-uri" name="query" value="" autofocus="" autocomplete="off" placeholder="/uri/to/purge">
					<input type="submit" class="btn submit" value="Purge URI">
				</div>
			</fieldset>

			<input type="hidden" name="purgeban_type" value="purge">
			<input type="hidden" name="{{ craft.config.csrfTokenName }}" value="{{ craft.request.csrfToken }}">
		</form>
	</div>

	<div id="tab-ban" class="hidden">
		<form id="frm-ban" class="purgeban">
			<div class="instructions">
				{% if admin_error is defined %}
					<p><b>Error with Varnish Admin socket:</b> <span class="error">{{ admin_error }}</span></p>
				{% endif %}

				{% if canDoAdminBans %}
				<p>Banning via admin socket on port <b>{{ craft.config.get('adminPort', 'varnishpurge') }}</b></p>
				{% else %}
				<p>Banning via HTTP - <b>Ensure your VCL supports ban header logic</b>.</p>
				{% endif %}
			</div>

			<fieldset>
				<div class="heading">
					<label id="title-label" class="required" for="ban-query">Query</label>
				</div>

				<div class="purgeban-query">
					{# <span class="prefix" id="ban-prefix"><span class="inner">{{ craft.config.get('banPrefix', 'varnishpurge') }}</span></span> #}
					<div class="select">
						<select name="host">
							<option value="">{{ 'Send to all hosts'|t }}</option>
							{% for id, host in hosts %}
							<option value="{{ id }}">{{ id }} ({{ host.hostName }})</option>
							{% endfor %}
						</select>
					</div>
					{# <a href="#" data-prefix-reveal="ban-prefix" class="prefix-reveal">&hellip;</a> #}
					<input class="text" type="text" id="ban-query" name="query" autofocus="" autocomplete="off" placeholder="req.http.host == ${hostname} &amp;&amp; req.url ~ .*" value="req.http.host == ${hostname} &amp;&amp; req.url ~ .*" class="">
					<input type="submit" class="btn submit" value="Send Ban Query">
				</div>

				<div class="templates">
					<b>Template keys available:</b>
					<ul>
						<li>${hostName}</li>
					</ul>
				</div>
			</fieldset>

			<input type="hidden" name="purgeban_type" value="ban">
			<input type="hidden" name="{{ craft.config.csrfTokenName }}" value="{{ craft.request.csrfToken }}">
		</form>
	</div>

	<div id="purgeban-output">
		<pre><code class="output">Purge/ban output</code></pre>
	</div>

	{% if (banlist is defined) %}
	<div class="dashboard">
		<div class="banlist">
			<h2>Current ban list</h2>

			<table class="data fullwidth">
				<thead>
					<tr>
						<th>Spec</th>
						<th>Flags</th>
						<th>Date</th>
					</tr>
				</thead>
				<tbody>
					{% for ban in banlist %}
					<tr>
						<td>{{ ban.spec }}</td>
						<td>{{ ban.flags }}</td>
						<td>{{ ban.gmdate|date('j M Y g:i a') }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	{% endif %}

	<form id="varnish-confirm-purge" method="post" class="varnish modal fitted" style="display: none">
		<div class="body">
			<h2>Clear entire cache</h2>
			<p>Are you sure you want to clear the entire cache?</p>
			<div class="buttons right" style="margin-top: 0;">
				<input type="button" class="btn" data-form-cancel value="Cancel">
				<input type="submit" class="btn submit" value="Clear">
				<input type="hidden" name="purgeban_type" value="ban">
				<input type="hidden" name="query" value=".*">
				<input type="hidden" name="{{ craft.config.csrfTokenName }}" value="{{ craft.request.csrfToken }}">
			</div>
		</div>
	</form>
{% endset %}